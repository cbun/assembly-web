"use strict";var app=angular.module("assemblyNgApp",["ngResource","ngCookies","ui.bootstrap","ngDragDrop","ngGrid","restangular","webStorageModule","blueimp.fileupload","frapontillo.bootstrap-switch"]);app.config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/dashboard.html",controller:"DashboardCtrl",access:{isFree:!1}}).when("/dashboard",{name:"dashboard",templateUrl:"views/dashboard.html",controller:"DashboardCtrl",access:{isFree:!1}}).when("/pipeline",{templateUrl:"views/main.html",controller:"UserFileCtrl",access:{isFree:!1}}).when("/upload",{templateUrl:"partials/uploader.html",access:{isFree:!1}}).when("/quick",{templateUrl:"partials/uploader.html",access:{isFree:!1}}).when("/login/:redirect",{name:"login",templateUrl:"partials/login.html",controller:"LoginCtrl",access:{isFree:!0}}).when("/login",{templateUrl:"partials/login.html",controller:"LoginCtrl",access:{isFree:!0}}).when("/welcome/",{templateUrl:"views/welcome.html",access:{isFree:!0}}).otherwise({redirectTo:"/welcome/"})}]),app.config(["$httpProvider",function(a){delete a.defaults.headers.common["X-Requested-With"],delete a.defaults.headers.common.Origin,console.log(a.defaults.headers.common)}]),app.config(["RestangularProvider",function(a){a.setBaseUrl("http://140.221.84.203:8000/"),a.setDefaultHeaders(),a.setResponseExtractor(function(a,b,c){if("node"===c){var d=a.data;return d}return a})}]),app.config(["$httpProvider","fileUploadProvider",function(a,b){delete a.defaults.headers.common["X-Requested-With"],console.log("config"),b.defaults.redirect=window.location.href.replace(/\/[^\/]*$/,"/cors/result.html?%s")}]),app.factory("kbaseSessionService",["webStorage",function(a){var b,c,d=!1;return{checkSession:function(){var b=a.session.get("kbase_session");return void 0!=b?(console.log("exists!"),this.setLoggedIn(b.user_id,b.token),!0):!1},clearSession:function(){a.session.clear(),d=!1},getUser:function(){return c},getToken:function(){return b},isLoggedIn:function(){return d},setToken:function(a){b=a},setUser:function(a){c=a},setLoggedIn:function(a,e){c=a,b=e,d=!0,console.log("Logged in"),console.log("kbaseSession: "+c),console.log("kbaseSession: "+b)}}}]),angular.module("assemblyNgApp").controller("UserFileCtrl",["$scope","$resource","Restangular","arastService","kbaseSessionService",function(a,b,c,d,e){a.arUser=e.getUser(),a.arToken=e.getToken(),a.stagedFilesFlat=[],a.stagedLibraries=[],a.libCount=0,a.shockUrl="",a.userFiles=[],a.arStage=1,a.nextStage=function(){a.arStage++},a.showUpload=!1,a.toggleUpload=function(){a.showUpload=!a.showUpload},a.stageFile=function(b){0==a.libCount&&a.addLibrary();var c=a.stagedLibraries.pop();c.shockObjs=c.shockObjs.concat(b),a.stagedLibraries.push(c)},a.addLibrary=function(){a.libCount++;var b="Library "+a.libCount,c={name:b,shockObjs:[],insert:null,stdev:null};a.stagedLibraries.push(c)},a.mySelections=[],a.gridOptions={data:"userFiles",selectedItems:a.mySelections,columnDefs:[{field:"file.name",displayName:"File Name"},{field:"file.size",displayName:"Size"}]},a.arModules=null,a.getArModules=function(){a.arModules||c.one("module/").getList().then(function(b){a.arModules=b,console.log(b)})},a.submitJob=function(){c.one("user",a.arUser).one("job","new");for(var b=0;b<a.stagedLibraries.length;b++){var e=a.stagedLibraries[b];d.addLib(e)}d.setPipeline(a.pipeline),console.log(d.getArRequest()),d.submitRequest()},a.pipeline=[],a.arServerUrl="140.221.84.203";var f=c.one("user",a.arUser);a.returnMsg=f.getList("files"),a.getShockUrl=function(){console.log("getShockUrl()");var a=c.one("shock/").getList();a.then(function(a){return a.shockurl})},a.listUserFiles=function(){var b=c.one("shock/").getList();b.then(function(a){return a.shockurl}).then(function(b){var d="http://"+b;console.log(d);var e=c.oneUrl("",d);e.getList("node",{},{}).then(function(b){for(var c=0;c<b.length;c++)a.userFiles.push(b[c])})})}}]);var isOnGitHub=!1,arasturl="http://140.221.84.203:8000",uploadUrl="";angular.module("assemblyNgApp").controller("ArFileUploadController",["$scope","$http","$filter","$window","arastService",function(a,b,c,d,e){a.arToken="un=cbun|tokenid=79e22acc-19bd-11e3-b4d5-1231391ccf32|expiry=1410314733|client_id=cbun|token_type=Bearer|SigningSubject=https://nexus.api.globusonline.org/goauth/keys/7aba18ba-19bd-11e3-b4d5-1231391ccf32|sig=0c77f654dd38869df4d8b32bec99d9e41a98f9e545f17f7b94cb05fdee88b3fd9e9d09cfafaa0020a59198445f54a5cb0aa21dca68d49f774b6b6a1c1a37a9a660abb48401b2934677480aec810dd03a6398a1b4d36d27e0b0b59a54b14a3b0bc662bfae2ebae8e043a35a2cb39b04dafd7a310c381c18d42f332031cf5ff11f",a.autoAssemble=!1,a.uploadText="",a.$watch("autoAssemble",function(){a.uploadText=a.autoAssemble?"Upload & Assemble":"Upload"}),b.get(arasturl+"/shock/").then(function(b){a.uploadUrl="http://"+b.data.shockurl+"/node/"}),a.options={url:uploadUrl},a.loadingFiles=!0,b.get(a.uploadUrl).then(function(b){a.loadingFiles=!1,a.queue=b.data.file||[]},function(){a.loadingFiles=!1}),a.$on("fileuploaddone",function(b,c){console.log("done");var d=c.result.data;console.log(d),e.addSingle(d),console.log(e.getArRequest()),a.autoAssemble&&(e.submitRequest(),console.log("submitted"))})}]).controller("FileDestroyController",["$scope","$http",function(a,b){var c,d=a.file;d.url?(d.$state=function(){return c},d.$destroy=function(){return c="pending",b({url:d.deleteUrl,method:d.deleteType}).then(function(){c="resolved",a.clear(d)},function(){c="rejected"})}):d.$cancel||d._index?console.log("do nothing"):d.$cancel=function(){a.clear(d)}}]),angular.module("assemblyNgApp").controller("ArStatusCtrl",["$scope","arastRestService",function(a,b){a.userDocs=b.getStatusAll(),a.mySelections=[],a.gridOptions={data:"userDocs",selectedItems:a.mySelections,multiSelect:!1,columnDefs:[{field:"job_id",displayName:"Job",width:100},{field:"status",displayName:"Status"},{field:"message",displayName:"Description"}]}}]),angular.module("assemblyNgApp").controller("DashboardCtrl",["$scope","$location","kbaseSessionService",function(a,b){a.dashView="files",a.tooltipQuick="Instantly perform automated assembly upon file uploads",a.tooltipCustom="Select libraries and create an assembly pipeline manually",a.tooltipAnalyze="Perform analysis methods on assemblies",a.clickQuick=function(){b.path("/quick")},a.clickCustom=function(){b.path("/pipeline")},a.changeDashView=function(b){a.dashView=b}}]),angular.module("assemblyNgApp").controller("MainCtrl",["$scope","$location","$route","kbaseSessionService","webStorage",function(a,b,c,d){a.loggedIn=d.isLoggedIn(),a.arUser=d.getUser(),a.loggedIn||d.checkSession()&&(console.log("has previous session. proceed"),a.loggedIn=d.isLoggedIn(),a.arUser=d.getUser()),b.path(),a.$on("$routeChangeStart",function(c,e){a.loggedIn=d.isLoggedIn(),a.arUser=d.getUser();var f=b.path();if(e.access.isFree||a.loggedIn)console.log("either logged, or access free"),console.log(a.loggedIn);else{var g="/login"+f;console.log(g),b.path(g)}}),a.logOut=function(){d.clearSession(),c.reload()}}]),angular.module("assemblyNgApp").controller("LoginCtrl",["$scope","$location","$route","$routeParams","kbaseSessionService",function(a,b,c,d,e){a.redirect=d.redirect,a.loggedIn=!1,a.$location=b,console.log(a.redirect),a.setLoggedIn=function(c,d){console.log("Redirecting!"+a.redirect),e.setLoggedIn(c,d),b.path("/"+a.redirect+"/"),a.$apply()}}]),angular.module("assemblyNgApp").controller("UploadCtrl",["$scope","$resource","Restangular",function(){}]),app.directive("arLib",function(){return{restrict:"E",scope:{libdata:"="},templateUrl:"templates/seqLibraryWidget.html"}}),app.directive("arLogin",function(){return{restrict:"A",controller:"LoginCtrl",link:function(a,b){$(b).kbaseLogin({style:"slim",login_callback:function(){var c=$(b).kbaseLogin("session","user_id"),d=$(b).kbaseLogin("session").token;a.setLoggedIn(c,d)}})}}}),angular.module("assemblyNgApp").factory("arastService",["Restangular","kbaseSessionService",function(a,b){var c=b.getUser(),d=b.getToken(),e={data_id:null,file_sizes:[],filename:[],ids:[],message:null,pipeline:[["kiki"]],queue:null,single:[[]],pair:[],reference:null,version:"webclient"};return{setValue:function(a,b){e[a]=b},formArRequest:function(){return"shockObjs"},getArRequest:function(){return e},addSingle:function(a){e.single[0].push(a.file.name),e.filename.push(a.file.name),e.file_sizes.push(a.file.size),e.ids.push(a.id)},addLib:function(a){var b,c=[];for(b=0;b<a.shockObjs.length;b++)c.push(a.shockObjs[b].file.name),e.filename.push(a.shockObjs[b].file.name),e.file_sizes.push(a.shockObjs[b].file.size),e.ids.push(a.shockObjs[b].id);2==a.shockObjs.length?e.pair.push(c):e.single[0]=e.single[0].concat(c)},setPipeline:function(a){var b;for(e.pipeline=[],b=0;b<a.length;b++)e.pipeline.push(a[b].name)},submitRequest:function(){var b=a.one("user",c).one("job");b.post("new",e,{},{Authorization:"OAuth "+d}).then(function(a){alert("Job submitted: "+a)})}}}]),angular.module("assemblyNgApp").factory("arastRestService",["kbaseSessionService","Restangular",function(a,b){var c=a.getUser();a.getToken();var d=b.one("user",c).one("job","status");return{getStatusAll:function(){return d.get()}}}]);